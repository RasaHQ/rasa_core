

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Policies &mdash; Rasa Core 0.10.0a2 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/banner.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Rasa Core 0.10.0a2 documentation" href="index.html"/>
        <link rel="next" title="Tracking Conversation State" href="state.html"/>
        <link rel="prev" title="Interpreters" href="interpreters.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Rasa Core
          

          
          </a>

          
            
            
              <div class="version">
                0.10
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="motivation.html">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="no_python.html">But I don&#8217;t code in python!</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorial_basics.html">Building a Simple Bot</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_supervised.html">Supervised Learning Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_interactive_learning.html">Interactive Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_remote.html">Rasa Core without Python</a></li>
</ul>
<p class="caption"><span class="caption-text">Deep Dives</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="domains.html">Domain, Slots, and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="stories.html">Stories - The Training Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="patterns.html">Slot Filling and Common Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="plumbing.html">Plumbing - How it all fits together</a></li>
<li class="toctree-l1"><a class="reference internal" href="http.html">HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectors.html">Connecting to messaging &amp; voice platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="connectors.html#using-ngrok-for-local-testing">Using Ngrok For Local Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="scheduling.html">Scheduling Reminders</a></li>
</ul>
<p class="caption"><span class="caption-text">Python API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/agent.html">Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/tracker.html">Dialogue State Tracker</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="featurisation.html">Featurization</a></li>
<li class="toctree-l1"><a class="reference internal" href="interpreters.html">Interpreters</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Policies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#creating-policies-from-stories">Creating Policies from Stories</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#memorising-the-training-data">Memorising the training data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#augmented-memoization">Augmented memoization</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#generalising-to-new-dialogues">Generalising to new Dialogues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#keras-policy">Keras policy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#embedding-policy">Embedding policy</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="state.html">Tracking Conversation State</a></li>
<li class="toctree-l1"><a class="reference internal" href="migrations.html">Migration Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Change Log</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Rasa Core</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Policies</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/policies.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

/* nice headers on first paragraph of info/warning boxes */
.admonition .first {
    margin: -12px;
    padding: 6px 12px;
    margin-bottom: 12px;
    color: #fff;
    line-height: 1;
    display: block;
}
.admonition.warning .first {
    background: #f0b37e;
}
.admonition.note .first {
    background: #6ab0de;
}
.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}
</style>
<div class="section" id="policies">
<span id="id1"></span><h1>Policies<a class="headerlink" href="#policies" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal"><span class="pre">Policy</span></code> is the core of your bot, with its most important method:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">predict_action_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="c1"># type: (DialogueStateTracker, Domain) -&gt; List[float]</span>
        <span class="sd">&quot;&quot;&quot;Predicts the next action the bot should take</span>
<span class="sd">        after seeing the tracker.</span>

<span class="sd">        Returns the list of probabilities for the next actions&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Policy must have the capacity &quot;</span>
                                  <span class="s2">&quot;to predict.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This uses the current state of the conversation (provided by the tracker) to choose the next action to take.
The domain is there if you need it, but only some policy types make use of it. The returned array contains
the probabilities for each action to be executed next. The action that is most likely will be executed.</p>
<p>Let&#8217;s look at a simple example for a custom policy:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rasa_core.policies</span> <span class="k">import</span> <span class="n">Policy</span>
<span class="kn">from</span> <span class="nn">rasa_core.actions.action</span> <span class="k">import</span> <span class="n">ACTION_LISTEN_NAME</span>
<span class="kn">from</span> <span class="nn">rasa_core</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">class</span> <span class="nc">SimplePolicy</span><span class="p">(</span><span class="n">Policy</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">predict_action_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tracker</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;greet&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">tracker</span><span class="o">.</span><span class="n">latest_action_name</span> <span class="o">==</span> <span class="n">ACTION_LISTEN_NAME</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">tracker</span><span class="o">.</span><span class="n">latest_message</span><span class="o">.</span><span class="n">intent</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">responses</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">responses</span> <span class="k">else</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">num_actions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">num_actions</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>How does this work?</strong>
When the controller processes a message from a user, it will keep asking for the next most likely action using
<code class="docutils literal"><span class="pre">predict_action_probabilities</span></code>. The bot then executes that action, then call <code class="docutils literal"><span class="pre">predict_action_probabilities</span></code> again
with a new <code class="docutils literal"><span class="pre">tracker</span></code>, until it receives an <code class="docutils literal"><span class="pre">ActionListen</span></code> instruction.
This breaks the loop and makes the bot await further instructions.</p>
<p>In pseudocode, what the <code class="docutils literal"><span class="pre">SimplePolicy</span></code> above does is:</p>
<div class="highlight-md"><div class="highlight"><pre><span></span>-&gt; a new message has come in

if we were previously listening:
    return a canned response
else:
    we must have just said something, so let&#39;s listen again
</pre></div>
</div>
<p>Note that the policy itself is stateless, and all the state is carried by the <code class="docutils literal"><span class="pre">tracker</span></code> object.</p>
<div class="section" id="creating-policies-from-stories">
<h2>Creating Policies from Stories<a class="headerlink" href="#creating-policies-from-stories" title="Permalink to this headline">¶</a></h2>
<p>Writing rules like in the SimplePolicy above is not a great way to build a bot, it gets messy fast &amp; is hard to debug.
If you&#8217;ve found Rasa Core, it&#8217;s likely you&#8217;ve already tried this approach and were looking for something better.</p>
<p>The second important method of any policy is <code class="docutils literal"><span class="pre">train(...)</span></code>:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">training_trackers</span><span class="p">,</span>  <span class="c1"># type: List[DialogueStateTracker]</span>
              <span class="n">domain</span><span class="p">,</span>  <span class="c1"># type: Domain</span>
              <span class="o">**</span><span class="n">kwargs</span>  <span class="c1"># type: **Any</span>
              <span class="p">):</span>
        <span class="c1"># type: (...) -&gt; None</span>
        <span class="sd">&quot;&quot;&quot;Trains the policy on given training trackers.&quot;&quot;&quot;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Policy must have the capacity &quot;</span>
                                  <span class="s2">&quot;to train.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This method creates &#8220;some rules&#8221; for prediction depending on the training data.</p>
<div class="section" id="memorising-the-training-data">
<h3>Memorising the training data<a class="headerlink" href="#memorising-the-training-data" title="Permalink to this headline">¶</a></h3>
<p>A good next step is to use our story framework to build a policy by giving it some example conversations.
We won&#8217;t use machine learning yet, we will just create a policy which memorises these stories.</p>
<p>We can use the <code class="docutils literal"><span class="pre">MemoizationPolicy</span></code> to do this.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For the <code class="docutils literal"><span class="pre">MemoizationPolicy</span></code>, the <code class="docutils literal"><span class="pre">train()</span></code> method just memorises
the actions taken in the story of <code class="docutils literal"><span class="pre">max_history</span></code> turns, so that when your bot encounters an
identical situation it will make the decision you intended.</p>
</div>
</div>
<div class="section" id="augmented-memoization">
<h3>Augmented memoization<a class="headerlink" href="#augmented-memoization" title="Permalink to this headline">¶</a></h3>
<p>If it is needed to recall turns from training dialogues
where some <code class="docutils literal"><span class="pre">slots</span></code> might not be set during prediction time,
add relevant stories without such <code class="docutils literal"><span class="pre">slots</span></code> to training data.
E.g. reminder stories.</p>
<p>Since <code class="docutils literal"><span class="pre">slots</span></code> that are set some time in the past are
preserved in all future feature vectors until they are set
to None, this policy has a capability to recall the turns
up to <code class="docutils literal"><span class="pre">max_history</span></code> and less from training stories during prediction,
even if additional slots were filled in the past for current dialogue.</p>
</div>
</div>
<div class="section" id="generalising-to-new-dialogues">
<h2>Generalising to new Dialogues<a class="headerlink" href="#generalising-to-new-dialogues" title="Permalink to this headline">¶</a></h2>
<p>The stories data format gives you a compact way to describe a large number of possible dialogues without much effort.
But humans are infinitely creative, and you could never hope to describe <em>every</em> possible dialogue programatically.
Even if you could, it probably wouldn&#8217;t fit in memory :)</p>
<p>So how do we create a policy which behaves well even in scenarios you haven&#8217;t thought of?
We will try to achieve this generalisation by creating a policy based on Machine Learning.</p>
<p>Any policy should be initialized with a featurizer.
The policy&#8217;s <code class="docutils literal"><span class="pre">train</span></code> method calls this featurizer on provided <code class="docutils literal"><span class="pre">training_trackers</span></code> to create <code class="docutils literal"><span class="pre">X,</span> <span class="pre">y</span></code> data,
suitable for ML algorithm (see <a class="reference internal" href="featurisation.html#featurization"><span class="std std-ref">Featurization</span></a> for details).</p>
<p>The method to featurize trackers is defined here:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">featurize_for_training</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">training_trackers</span><span class="p">,</span>  <span class="c1"># type: List[DialogueStateTracker]</span>
            <span class="n">domain</span><span class="p">,</span>  <span class="c1"># type: Domain</span>
            <span class="o">**</span><span class="n">kwargs</span>  <span class="c1"># type: **Any</span>
    <span class="p">):</span>
        <span class="c1"># type: (...) -&gt; DialogueTrainingData</span>
        <span class="sd">&quot;&quot;&quot;Transform training trackers into a vector representation.</span>
<span class="sd">        The trackers, consisting of multiple turns, will be transformed</span>
<span class="sd">        into a float vector which can be used by a ML model.&quot;&quot;&quot;</span>

        <span class="n">training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurizer</span><span class="o">.</span><span class="n">featurize_trackers</span><span class="p">(</span><span class="n">training_trackers</span><span class="p">,</span>
                                                           <span class="n">domain</span><span class="p">)</span>

        <span class="n">max_training_samples</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_training_samples&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_training_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Limit training data to </span><span class="si">{}</span><span class="s2"> training samples.&quot;</span>
                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_training_samples</span><span class="p">))</span>
            <span class="n">training_data</span><span class="o">.</span><span class="n">limit_training_data_to</span><span class="p">(</span><span class="n">max_training_samples</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">training_data</span>
</pre></div>
</div>
<div class="section" id="keras-policy">
<h3>Keras policy<a class="headerlink" href="#keras-policy" title="Permalink to this headline">¶</a></h3>
<p>You can use whichever machine learning library you like to train your policy.
One implementation that ships with Rasa is the <code class="docutils literal"><span class="pre">KerasPolicy</span></code>,
which uses Keras as a machine learning library to train your dialogue model.
This class has already implemented the logic of persisting and reloading models.</p>
<p>The model is defined here:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">model_architecture</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">input_shape</span><span class="p">,</span>  <span class="c1"># type: Tuple[int, int]</span>
            <span class="n">output_shape</span>  <span class="c1"># type: Tuple[int, Optional[int]]</span>
    <span class="p">):</span>
        <span class="c1"># type: (...) -&gt; keras.models.Sequential</span>
        <span class="sd">&quot;&quot;&quot;Build a keras model and return a compiled model.&quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Sequential</span>
        <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="k">import</span> \
            <span class="n">Masking</span><span class="p">,</span> <span class="n">LSTM</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">TimeDistributed</span><span class="p">,</span> <span class="n">Activation</span>

        <span class="c1"># Build Model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>

        <span class="c1"># the shape of the y vector of the labels,</span>
        <span class="c1"># determines which output from rnn will be used</span>
        <span class="c1"># to calculate the loss</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># y is (num examples, num features) so</span>
            <span class="c1"># only the last output from the rnn is used to</span>
            <span class="c1"># calculate the loss</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Masking</span><span class="p">(</span><span class="n">mask_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rnn_size</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">input_dim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rnn_size</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># y is (num examples, max_dialogue_len, num features) so</span>
            <span class="c1"># all the outputs from the rnn are used to</span>
            <span class="c1"># calculate the loss, therefore a sequence is returned and</span>
            <span class="c1"># time distributed layer is used</span>

            <span class="c1"># the first value in input_shape is max dialogue_len,</span>
            <span class="c1"># it is set to None, to allow dynamic_rnn creation</span>
            <span class="c1"># during prediction</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Masking</span><span class="p">(</span><span class="n">mask_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">LSTM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rnn_size</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">output_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot construct the model because&quot;</span>
                             <span class="s2">&quot;length of output_shape = </span><span class="si">{}</span><span class="s2"> &quot;</span>
                             <span class="s2">&quot;should be 1 or 2.&quot;</span>
                             <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_shape</span><span class="p">)))</span>

        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>

        <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
                      <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;rmsprop&#39;</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">model</span>
</pre></div>
</div>
<p>and the training is run here:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">training_trackers</span><span class="p">,</span>  <span class="c1"># type: List[DialogueStateTracker]</span>
              <span class="n">domain</span><span class="p">,</span>  <span class="c1"># type: Domain</span>
              <span class="o">**</span><span class="n">kwargs</span>  <span class="c1"># type: **Any</span>
              <span class="p">):</span>
        <span class="c1"># type: (...) -&gt; Dict[Text: Any]</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rnn_size&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parameter `rnn_size` is updated with </span><span class="si">{}</span><span class="s2">&quot;</span>
                         <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rnn_size&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rnn_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rnn_size&#39;</span><span class="p">)</span>

        <span class="n">training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">featurize_for_training</span><span class="p">(</span><span class="n">training_trackers</span><span class="p">,</span>
                                                    <span class="n">domain</span><span class="p">,</span>
                                                    <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">shuffled_X</span><span class="p">,</span> <span class="n">shuffled_y</span> <span class="o">=</span> <span class="n">training_data</span><span class="o">.</span><span class="n">shuffled_X_y</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_architecture</span><span class="p">(</span><span class="n">shuffled_X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                                 <span class="n">shuffled_y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">validation_split</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;validation_split&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting model with </span><span class="si">{}</span><span class="s2"> total samples and a validation &quot;</span>
                    <span class="s2">&quot;split of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">training_data</span><span class="o">.</span><span class="n">num_examples</span><span class="p">(),</span>
                                         <span class="n">validation_split</span><span class="p">))</span>
        <span class="c1"># filter out kwargs that cannot be passed to fit</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_valid_params</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">shuffled_X</span><span class="p">,</span> <span class="n">shuffled_y</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># the default parameter for epochs in keras fit is 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_epoch</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epochs&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done fitting keras policy model&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can implement the model of your choice by overriding these methods,
or initialize <code class="docutils literal"><span class="pre">KerasPolicy</span></code> with already defined <code class="docutils literal"><span class="pre">keras</span> <span class="pre">model</span></code>.</p>
</div>
<div class="section" id="embedding-policy">
<h3>Embedding policy<a class="headerlink" href="#embedding-policy" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>This policy has predefined architecture, which comprises the following steps:</dt>
<dd><ul class="first last simple">
<li>apply dense layers to create embeddings for user intents and entities and system actions including previous actions and slots;</li>
<li>concatenate the embeddings of previous user inputs and embeddings of previous system actions to create a memory;</li>
<li>concatenate user embeddings and slots into an attention wrapper input vector;</li>
<li>using the input vector and the previous LSTM output calculate attention probabilities over the memory
using <a class="reference external" href="https://arxiv.org/abs/1410.5401">NTM mechanism</a>;</li>
<li>feed the attention vectors and the embeddings of the slots as an input to an LSTM cell;</li>
<li>apply a dense layer to the output of the LSTM to get a recurrent embedding of a dialogue;</li>
<li>for each LSTM time step, calculate the similarity between this dialogue embedding and embedded system actions.
This step is based on the starspace idea from: <a class="reference external" href="https://arxiv.org/abs/1709.03856">https://arxiv.org/abs/1709.03856</a>.</li>
</ul>
</dd>
</dl>
<p>It is recommended to use <code class="docutils literal"><span class="pre">LabelTokenizerSingleStateFeaturizer</span></code> (see <a class="reference internal" href="featurisation.html#featurization"><span class="std std-ref">Featurization</span></a> for details).
.. note:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>This policy only works with ``FullDialogueTrackerFeaturizer``.
</pre></div>
</div>
<p><strong>Configuration</strong>:</p>
<blockquote>
<div><p>Configuration parameters can be passed to <code class="docutils literal"><span class="pre">agent.train(...)</span></code> method.
.. note:: Pass appropriate <code class="docutils literal"><span class="pre">epochs</span></code> number to <code class="docutils literal"><span class="pre">agent.train(...)</span></code> method,</p>
<blockquote>
<div>otherwise the policy will be trained only for <code class="docutils literal"><span class="pre">1</span></code> epoch. Since this is embedding based policy,
it requires large number of epochs, which depends on complexity of the training data and whether
attention was turned on or not.</div></blockquote>
<p>The main feature of this policy is <strong>attention</strong> mechanism over previous user input and system actions.
<strong>Attention is turned off by default</strong>, in order to turn it on, configure the following parameters:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">use_attention</span></code> if <code class="docutils literal"><span class="pre">true</span></code> the algorithm will use attention mechanism, default <code class="docutils literal"><span class="pre">false</span></code>;</li>
<li><code class="docutils literal"><span class="pre">sparse_attention</span></code> if <code class="docutils literal"><span class="pre">true</span></code> <code class="docutils literal"><span class="pre">sparsemax</span></code> will be used instead of <code class="docutils literal"><span class="pre">softmax</span></code> for attention probabilities, default <code class="docutils literal"><span class="pre">false</span></code>;</li>
<li><code class="docutils literal"><span class="pre">attn_shift_range</span></code> the range of allowed location-based attention shifts, see <a class="reference external" href="https://arxiv.org/abs/1410.5401">https://arxiv.org/abs/1410.5401</a> for details;</li>
<li><code class="docutils literal"><span class="pre">skip_cells</span></code> if <code class="docutils literal"><span class="pre">true</span></code> the algorithm will add sigmoid gate to skip rnn time step for LSTM&#8217;s hidden memory state.</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Attention requires larger values of <code class="docutils literal"><span class="pre">epochs</span></code> and takes longer to train. But it can learn more complicated and nonlinear behaviour.</p>
</div>
<dl class="docutils">
<dt>The algorithm also has hyperparameters to control:</dt>
<dd><ul class="first last simple">
<li><dl class="first docutils">
<dt>neural network&#8217;s architecture:</dt>
<dd><ul class="first last">
<li><code class="docutils literal"><span class="pre">num_hidden_layers_a</span></code> and <code class="docutils literal"><span class="pre">hidden_layer_size_a</span></code> set the number of hidden layers and their sizes before embedding layer for user inputs;</li>
<li><code class="docutils literal"><span class="pre">num_hidden_layers_b</span></code> and <code class="docutils literal"><span class="pre">hidden_layer_size_b</span></code> set the number of hidden layers and their sizes before embedding layer for system actions;</li>
<li><code class="docutils literal"><span class="pre">rnn_size</span></code> set the number of units in the LSTM cell;</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>training:</dt>
<dd><ul class="first last">
<li><code class="docutils literal"><span class="pre">batch_size</span></code> sets the number of training examples in one forward/backward pass, the higher the batch size, the more memory space you&#8217;ll need;</li>
<li><code class="docutils literal"><span class="pre">epochs</span></code> sets the number of times the algorithm will see training data, where <code class="docutils literal"><span class="pre">one</span> <span class="pre">epoch</span></code> = one forward pass and one backward pass of all the training examples;</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>embedding:</dt>
<dd><ul class="first last">
<li><code class="docutils literal"><span class="pre">embed_dim</span></code> sets the dimension of embedding space;</li>
<li><code class="docutils literal"><span class="pre">mu_pos</span></code> controls how similar the algorithm should try to make embedding vectors for correct intent labels;</li>
<li><code class="docutils literal"><span class="pre">mu_neg</span></code> controls maximum negative similarity for incorrect intents;</li>
<li><code class="docutils literal"><span class="pre">similarity_type</span></code> sets the type of the similarity, it should be either <code class="docutils literal"><span class="pre">cosine</span></code> or <code class="docutils literal"><span class="pre">inner</span></code>;</li>
<li><code class="docutils literal"><span class="pre">num_neg</span></code> sets the number of incorrect intent labels, the algorithm will minimize their similarity to the user input during training;</li>
<li><code class="docutils literal"><span class="pre">use_max_sim_neg</span></code> if <code class="docutils literal"><span class="pre">true</span></code> the algorithm only minimizes maximum similarity over incorrect intent labels;</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>regularization:</dt>
<dd><ul class="first last">
<li><code class="docutils literal"><span class="pre">C2</span></code> sets the scale of L2 regularization</li>
<li><code class="docutils literal"><span class="pre">C_emb</span></code> sets the scale of how important is to minimize the maximum similarity between embeddings of different intent labels;</li>
<li><code class="docutils literal"><span class="pre">droprate_a</span></code> sets the dropout rate between hidden layers before embedding layer for user inputs;</li>
<li><code class="docutils literal"><span class="pre">droprate_b</span></code> sets the dropout rate between hidden layers before embedding layer for system actions;</li>
<li><code class="docutils literal"><span class="pre">droprate_rnn</span></code> sets the recurrent dropout rate on the LSTM hidden state <a class="reference external" href="https://arxiv.org/abs/1603.05118">https://arxiv.org/abs/1603.05118</a>;</li>
<li><code class="docutils literal"><span class="pre">droprate_out</span></code> sets the dropout rate on the output of the LSTM before embedding layer for the current time step of the dialogue;</li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Droprate should be between <code class="docutils literal"><span class="pre">0</span></code> and <code class="docutils literal"><span class="pre">1</span></code>, e.g. <code class="docutils literal"><span class="pre">droprate=0.1</span></code> would drop out <code class="docutils literal"><span class="pre">10%</span></code> of input units</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For <code class="docutils literal"><span class="pre">cosine</span></code> similarity <code class="docutils literal"><span class="pre">mu_pos</span></code> and <code class="docutils literal"><span class="pre">mu_neg</span></code> should be between <code class="docutils literal"><span class="pre">-1</span></code> and <code class="docutils literal"><span class="pre">1</span></code>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is an option to use linearly increasing batch size. The idea comes from <a class="reference external" href="https://arxiv.org/abs/1711.00489">https://arxiv.org/abs/1711.00489</a>.
In order to do it pass a list to <code class="docutils literal"><span class="pre">batch_size</span></code>, e.g. <code class="docutils literal"><span class="pre">&quot;batch_size&quot;:</span> <span class="pre">[8,</span> <span class="pre">32]</span></code> (default behaviour).
If constant <code class="docutils literal"><span class="pre">batch_size</span></code> is required, pass an <code class="docutils literal"><span class="pre">int</span></code>, e.g. <code class="docutils literal"><span class="pre">&quot;batch_size&quot;:</span> <span class="pre">8</span></code>.</p>
</div>
<p>you can pass these parameters to <cite>agent.train(...)</cite> method:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Parameter <code class="docutils literal"><span class="pre">mu_neg</span></code> is set to a negative value to mimic the original
starspace algorithm in the case <code class="docutils literal"><span class="pre">mu_neg</span> <span class="pre">=</span> <span class="pre">mu_pos</span></code> and <code class="docutils literal"><span class="pre">use_max_sim_neg</span> <span class="pre">=</span> <span class="pre">False</span></code>.
See <a class="reference external" href="https://arxiv.org/abs/1709.03856">starspace paper</a> for details.</p>
</div>
</div></blockquote>
</div>
</div>
</div>


           </div>
          </div>
          <footer>

  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="state.html" class="btn btn-neutral float-right" title="Tracking Conversation State" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="interpreters.html" class="btn btn-neutral" title="Interpreters" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Rasa Technologies GmbH.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: embed_policy
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../0.6.5/policies.html">0.6.5</a></dd>
            <dd><a href="../0.6.9/policies.html">0.6.9</a></dd>
            <dd><a href="../0.7.0/policies.html">0.7.0</a></dd>
            <dd><a href="../0.7.0a10/policies.html">0.7.0a10</a></dd>
            <dd><a href="../0.7.0a5/policies.html">0.7.0a5</a></dd>
            <dd><a href="../0.7.0a6/policies.html">0.7.0a6</a></dd>
            <dd><a href="../0.7.0a7/policies.html">0.7.0a7</a></dd>
            <dd><a href="../0.7.0a8/policies.html">0.7.0a8</a></dd>
            <dd><a href="../0.7.0a9/policies.html">0.7.0a9</a></dd>
            <dd><a href="../0.7.1/policies.html">0.7.1</a></dd>
            <dd><a href="../0.7.2/policies.html">0.7.2</a></dd>
            <dd><a href="../0.7.3/policies.html">0.7.3</a></dd>
            <dd><a href="../0.7.4/policies.html">0.7.4</a></dd>
            <dd><a href="../0.7.5/policies.html">0.7.5</a></dd>
            <dd><a href="../0.7.6/policies.html">0.7.6</a></dd>
            <dd><a href="../0.7.7/policies.html">0.7.7</a></dd>
            <dd><a href="../0.7.8/policies.html">0.7.8</a></dd>
            <dd><a href="../0.7.9/policies.html">0.7.9</a></dd>
            <dd><a href="../0.8.0/policies.html">0.8.0</a></dd>
            <dd><a href="../0.8.1/policies.html">0.8.1</a></dd>
            <dd><a href="../0.8.2/policies.html">0.8.2</a></dd>
            <dd><a href="../0.8.3/policies.html">0.8.3</a></dd>
            <dd><a href="../0.8.4/policies.html">0.8.4</a></dd>
            <dd><a href="../0.8.5/policies.html">0.8.5</a></dd>
            <dd><a href="../0.8.6/policies.html">0.8.6</a></dd>
            <dd><a href="../0.9.0/policies.html">0.9.0</a></dd>
            <dd><a href="../0.9.0a1/policies.html">0.9.0a1</a></dd>
            <dd><a href="../0.9.0a2/policies.html">0.9.0a2</a></dd>
            <dd><a href="../0.9.0a3/policies.html">0.9.0a3</a></dd>
            <dd><a href="../0.9.0a5/policies.html">0.9.0a5</a></dd>
            <dd><a href="../0.9.0a7/policies.html">0.9.0a7</a></dd>
            <dd><a href="../0.9.1/policies.html">0.9.1</a></dd>
            <dd><a href="../0.9.2/policies.html">0.9.2</a></dd>
            <dd><a href="../0.9.3/policies.html">0.9.3</a></dd>
            <dd><a href="../0.9.4/policies.html">0.9.4</a></dd>
            <dd><a href="../0.9.5/policies.html">0.9.5</a></dd>
            <dd><a href="../0.9.6/policies.html">0.9.6</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../0.9.x/policies.html">0.9.x</a></dd>
            <dd><a href="../add-auth/policies.html">add-auth</a></dd>
            <dd><a href="../apscheduler_try/policies.html">apscheduler_try</a></dd>
            <dd><a href="../async/policies.html">async</a></dd>
            <dd><a href="../direct_input/policies.html">direct_input</a></dd>
            <dd><a href="../dispatcher/policies.html">dispatcher</a></dd>
            <dd><a href="policies.html">embed_policy</a></dd>
            <dd><a href="../eval_scripts/policies.html">eval_scripts</a></dd>
            <dd><a href="../event-stream/policies.html">event-stream</a></dd>
            <dd><a href="../fix/policies.html">fix</a></dd>
            <dd><a href="../master/policies.html">master</a></dd>
            <dd><a href="../model-pull/policies.html">model-pull</a></dd>
            <dd><a href="../track_data/policies.html">track_data</a></dd>
            <dd><a href="../train_from_url/policies.html">train_from_url</a></dd>
            <dd><a href="../wildcard/policies.html">wildcard</a></dd>
        </dl>
    </div>
</div>


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.10.0a2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>

  
  
 
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script type="text/javascript" src="//script.crazyegg.com/pages/scripts/0074/3851.js" async="async"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-87333416-1"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments)};
gtag('js', new Date());

gtag('config', 'UA-87333416-1');
</script>


</body>
</html>